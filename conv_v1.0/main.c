#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <stdint.h>
#include <stdbool.h>
#include "./dnn_conv.h"
#include "./demod.h"
#include <time.h>

#define PARAM_DATA "neural_net_parameters.bin"
#define RF_DATA "rf-00-A"

const uint32_t log_compression_lut[];

int main(int argc, char* argv[]) {

	// Initialize variables for RF Data (binary file) ---> B-mode image (576 X 80 integer)
	int16_t input[SAMPLES * ALINES];
	uint8_t env[SAMPLES / DEC_FACTOR * ALINES];
	uint8_t LUT[POWER11];
	
	// Reading and storing log compression look up table
	for(int i = 0; i < POWER11; i++) {
		LUT[i] = ((uint8_t*) log_compression_lut)[i];
	}

	// Preallocate data
	int16_t *inputBuf = (int16_t *) malloc(SAMPLES * ALINES * BYTES_PER_SAMPLE);
	if (!inputBuf) {
		perror("Could not allocate memory");
		exit(EXIT_FAILURE);
	}

	// Opening RF binary data
	FILE *f = fopen(RF_DATA, "rb");
	if (!f) {
		perror("Could not open file");
		exit(EXIT_FAILURE);
	}

	// Reading data to pass in input to demod
	fread(inputBuf, BYTES_PER_SAMPLE, SAMPLES * ALINES, f);
	for(int i = 0; i < SAMPLES * ALINES; i++) {
		input[i] = inputBuf[i];
	}

	demod(input, env, LUT);
	fclose(f);

	// Begin convolution
	load(PARAM_DATA);
	decimation(env);

	clock_t start = clock(), diff;
	float *prob_map = convolution();
	diff = clock() - start;
	int msec = diff * 1000 / CLOCKS_PER_SEC;
	printf("Convolution took %d seconds %d milliseconds\n", msec/1000, msec%1000);

	// make_files();
	free_memory();
	printf("Hooray!");
	return 0;
}

/**
 * log compression LUT
 */
const uint32_t log_compression_lut[2048/4] = {
	  50462976U,  117835012U,  185207048U,  252579084U,   /*    1 -   16 */
	 319951120U,  387323156U,  454695192U,  522067228U,   /*   17 -   32 */
	 589439264U,  656811300U,  724183336U,  791555372U,   /*   33 -   48 */
	 858927408U,  926299444U,  993671480U, 1044200508U,   /*   49 -   64 */
	1111572543U, 1162101570U, 1212630598U, 1263159625U,   /*   65 -   80 */
	1313688651U, 1347374926U, 1397903697U, 1431589971U,   /*   81 -   96 */
	1465341526U, 1515804760U, 1549491034U, 1583177052U,   /*   97 -  112 */
	1616863070U, 1650549088U, 1667457634U, 1701143652U,   /*  113 -  128 */
	1734764134U, 1768450151U, 1785358697U, 1818979179U,   /*  129 -  144 */
	1835887724U, 1869508206U, 1886416751U, 1920037233U,   /*  145 -  160 */
	1936945778U, 1953789043U, 1987409269U, 2004317814U,   /*  161 -  176 */
	2021161079U, 2038004088U, 2071624314U, 2088467323U,   /*  177 -  192 */
	2105375868U, 2122219133U, 2139062142U, 2155905151U,   /*  193 -  208 */
	2172748161U, 2189591170U, 2206434179U, 2223277188U,   /*  209 -  224 */
	2240120197U, 2256963206U, 2273806215U, 2290649224U,   /*  225 -  240 */
	2307492232U, 2324335241U, 2341178250U, 2358021003U,   /*  241 -  256 */
	2374798476U, 2391641485U, 2391707278U, 2408550287U,   /*  257 -  272 */
	2425393295U, 2442236048U, 2459013521U, 2459079314U,   /*  273 -  288 */
	2475922323U, 2492765331U, 2509542548U, 2509608341U,   /*  289 -  304 */
	2526451350U, 2543294102U, 2560071575U, 2560137368U,   /*  305 -  320 */
	2576980376U, 2593757593U, 2593823386U, 2610666394U,   /*  321 -  336 */
	2627443611U, 2627509404U, 2644352412U, 2661129629U,   /*  337 -  352 */
	2661195422U, 2678038430U, 2678038431U, 2694881440U,   /*  353 -  368 */
	2711658656U, 2711724449U, 2728567457U, 2728567458U,   /*  369 -  384 */
	2745410467U, 2762187683U, 2762253476U, 2779096228U,   /*  385 -  400 */
	2779096485U, 2795939493U, 2795939494U, 2812782502U,   /*  401 -  416 */
	2812782503U, 2829625512U, 2829625512U, 2846468521U,   /*  417 -  432 */
	2846468521U, 2863311530U, 2863311530U, 2880154539U,   /*  433 -  448 */
	2880154539U, 2896997548U, 2896997548U, 2913840557U,   /*  449 -  464 */
	2913840557U, 2930683566U, 2930683566U, 2947526574U,   /*  465 -  480 */
	2947526575U, 2964369583U, 2964369584U, 2981212336U,   /*  481 -  496 */
	2981212593U, 2997989809U, 2998055602U, 2998055602U,   /*  497 -  512 */
	3014898611U, 3014898611U, 3031741619U, 3031741620U,   /*  513 -  528 */
	3048518836U, 3048584629U, 3048584629U, 3065427637U,   /*  529 -  544 */
	3065427638U, 3082270390U, 3082270647U, 3082270647U,   /*  545 -  560 */
	3099113656U, 3099113656U, 3115890872U, 3115956665U,   /*  561 -  576 */
	3115956665U, 3132799673U, 3132799674U, 3132799674U,   /*  577 -  592 */
	3149642683U, 3149642683U, 3166485435U, 3166485692U,   /*  593 -  608 */
	3166485692U, 3183328700U, 3183328701U, 3183328701U,   /*  609 -  624 */
	3200171710U, 3200171710U, 3200171710U, 3217014719U,   /*  625 -  640 */
	3217014719U, 3233791935U, 3233857728U, 3233857728U,   /*  641 -  656 */
	3250634944U, 3250700737U, 3250700737U, 3267477953U,   /*  657 -  672 */
	3267543746U, 3267543746U, 3284320962U, 3284386755U,   /*  673 -  688 */
	3284386755U, 3284386755U, 3301229764U, 3301229764U,   /*  689 -  704 */
	3301229764U, 3318072773U, 3318072773U, 3318072773U,   /*  705 -  720 */
	3334915781U, 3334915782U, 3334915782U, 3351758534U,   /*  721 -  736 */
	3351758791U, 3351758791U, 3368536007U, 3368601800U,   /*  737 -  752 */
	3368601800U, 3368601800U, 3385444808U, 3385444809U,   /*  753 -  768 */
	3385444809U, 3402222025U, 3402287818U, 3402287818U,   /*  769 -  784 */
	3402287818U, 3419130826U, 3419130827U, 3419130827U,   /*  785 -  800 */
	3435908043U, 3435973836U, 3435973836U, 3435973836U,   /*  801 -  816 */
	3452816588U, 3452816845U, 3452816845U, 3452816845U,   /*  817 -  832 */
	3469659853U, 3469659854U, 3469659854U, 3469659854U,   /*  833 -  848 */
	3486502863U, 3486502863U, 3486502863U, 3503280079U,   /*  849 -  864 */
	3503345872U, 3503345872U, 3503345872U, 3520123088U,   /*  865 -  880 */
	3520188881U, 3520188881U, 3520188881U, 3536966097U,   /*  881 -  896 */
	3537031890U, 3537031890U, 3537031890U, 3553809106U,   /*  897 -  912 */
	3553874899U, 3553874899U, 3553874899U, 3553874899U,   /*  913 -  928 */
	3570717908U, 3570717908U, 3570717908U, 3570717908U,   /*  929 -  944 */
	3587560917U, 3587560917U, 3587560917U, 3587560917U,   /*  945 -  960 */
	3604403669U, 3604403926U, 3604403926U, 3604403926U,   /*  961 -  976 */
	3621181142U, 3621246935U, 3621246935U, 3621246935U,   /*  977 -  992 */
	3621246935U, 3638089943U, 3638089944U, 3638089944U,   /*  993 - 1008 */
	3638089944U, 3654867160U, 3654932953U, 3654932953U,   /* 1009 - 1024 */
	3654932953U, 3654932953U, 3671775961U, 3671775962U,   /* 1025 - 1040 */
	3671775962U, 3671775962U, 3671775962U, 3688618971U,   /* 1041 - 1056 */
	3688618971U, 3688618971U, 3688618971U, 3705396187U,   /* 1057 - 1072 */
	3705461980U, 3705461980U, 3705461980U, 3705461980U,   /* 1073 - 1088 */
	3722239196U, 3722304989U, 3722304989U, 3722304989U,   /* 1089 - 1104 */
	3722304989U, 3739082205U, 3739147998U, 3739147998U,   /* 1105 - 1120 */
	3739147998U, 3739147998U, 3755925214U, 3755991007U,   /* 1121 - 1136 */
	3755991007U, 3755991007U, 3755991007U, 3772768223U,   /* 1137 - 1152 */
	3772834016U, 3772834016U, 3772834016U, 3772834016U,   /* 1153 - 1168 */
	3772834016U, 3789677025U, 3789677025U, 3789677025U,   /* 1169 - 1184 */
	3789677025U, 3789677025U, 3806519777U, 3806520034U,   /* 1185 - 1200 */
	3806520034U, 3806520034U, 3806520034U, 3823297250U,   /* 1201 - 1216 */
	3823363043U, 3823363043U, 3823363043U, 3823363043U,   /* 1217 - 1232 */
	3823363043U, 3840206051U, 3840206052U, 3840206052U,   /* 1233 - 1248 */
	3840206052U, 3840206052U, 3840206052U, 3857049061U,   /* 1249 - 1264 */
	3857049061U, 3857049061U, 3857049061U, 3857049061U,   /* 1265 - 1280 */
	3873826277U, 3873892070U, 3873892070U, 3873892070U,   /* 1281 - 1296 */
	3873892070U, 3873892070U, 3890734822U, 3890735079U,   /* 1297 - 1312 */
	3890735079U, 3890735079U, 3890735079U, 3890735079U,   /* 1313 - 1328 */
	3907577831U, 3907578088U, 3907578088U, 3907578088U,   /* 1329 - 1344 */
	3907578088U, 3907578088U, 3924420840U, 3924421097U,   /* 1345 - 1360 */
	3924421097U, 3924421097U, 3924421097U, 3924421097U,   /* 1361 - 1376 */
	3941263849U, 3941264106U, 3941264106U, 3941264106U,   /* 1377 - 1392 */
	3941264106U, 3941264106U, 3941264106U, 3958107115U,   /* 1393 - 1408 */
	3958107115U, 3958107115U, 3958107115U, 3958107115U,   /* 1409 - 1424 */
	3958107115U, 3974950123U, 3974950124U, 3974950124U,   /* 1425 - 1440 */
	3974950124U, 3974950124U, 3974950124U, 3991727340U,   /* 1441 - 1456 */
	3991793133U, 3991793133U, 3991793133U, 3991793133U,   /* 1457 - 1472 */
	3991793133U, 3991793133U, 4008636141U, 4008636142U,   /* 1473 - 1488 */
	4008636142U, 4008636142U, 4008636142U, 4008636142U,   /* 1489 - 1504 */
	4008636142U, 4025479151U, 4025479151U, 4025479151U,   /* 1505 - 1520 */
	4025479151U, 4025479151U, 4025479151U, 4025479151U,   /* 1521 - 1536 */
	4042322160U, 4042322160U, 4042322160U, 4042322160U,   /* 1537 - 1552 */
	4042322160U, 4042322160U, 4042322160U, 4059165169U,   /* 1553 - 1568 */
	4059165169U, 4059165169U, 4059165169U, 4059165169U,   /* 1569 - 1584 */
	4059165169U, 4059165169U, 4076008178U, 4076008178U,   /* 1585 - 1600 */
	4076008178U, 4076008178U, 4076008178U, 4076008178U,   /* 1601 - 1616 */
	4076008178U, 4092851186U, 4092851187U, 4092851187U,   /* 1617 - 1632 */
	4092851187U, 4092851187U, 4092851187U, 4092851187U,   /* 1633 - 1648 */
	4109693939U, 4109694196U, 4109694196U, 4109694196U,   /* 1649 - 1664 */
	4109694196U, 4109694196U, 4109694196U, 4109694196U,   /* 1665 - 1680 */
	4126537205U, 4126537205U, 4126537205U, 4126537205U,   /* 1681 - 1696 */
	4126537205U, 4126537205U, 4126537205U, 4143314421U,   /* 1697 - 1712 */
	4143380214U, 4143380214U, 4143380214U, 4143380214U,   /* 1713 - 1728 */
	4143380214U, 4143380214U, 4143380214U, 4160222966U,   /* 1729 - 1744 */
	4160223223U, 4160223223U, 4160223223U, 4160223223U,   /* 1745 - 1760 */
	4160223223U, 4160223223U, 4160223223U, 4177065975U,   /* 1761 - 1776 */
	4177066232U, 4177066232U, 4177066232U, 4177066232U,   /* 1777 - 1792 */
	4177066232U, 4177066232U, 4177066232U, 4193908984U,   /* 1793 - 1808 */
	4193909241U, 4193909241U, 4193909241U, 4193909241U,   /* 1809 - 1824 */
	4193909241U, 4193909241U, 4193909241U, 4210686457U,   /* 1825 - 1840 */
	4210752250U, 4210752250U, 4210752250U, 4210752250U,   /* 1841 - 1856 */
	4210752250U, 4210752250U, 4210752250U, 4210752250U,   /* 1857 - 1872 */
	4227595259U, 4227595259U, 4227595259U, 4227595259U,   /* 1873 - 1888 */
	4227595259U, 4227595259U, 4227595259U, 4227595259U,   /* 1889 - 1904 */
	4244438011U, 4244438268U, 4244438268U, 4244438268U,   /* 1905 - 1920 */
	4244438268U, 4244438268U, 4244438268U, 4244438268U,   /* 1921 - 1936 */
	4244438268U, 4261281276U, 4261281277U, 4261281277U,   /* 1937 - 1952 */
	4261281277U, 4261281277U, 4261281277U, 4261281277U,   /* 1953 - 1968 */
	4261281277U, 4261281277U, 4278124286U, 4278124286U,   /* 1969 - 1984 */
	4278124286U, 4278124286U, 4278124286U, 4278124286U,   /* 1985 - 2000 */
	4278124286U, 4278124286U, 4278124286U, 4294967295U,   /* 2001 - 2016 */
	4294967295U, 4294967295U, 4294967295U, 4294967295U,   /* 2017 - 2032 */
	4294967295U, 4294967295U, 4294967295U, 4294967295U};  /* 2033 - 2048 */
